---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: geoblock-ch-only
  namespace: envoy-gateway-system
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: external
  type: JSONPatch
  jsonPatches:
    - type: type.googleapis.com/envoy.config.listener.v3.Listener
      name: envoy-gateway-system/external/external-https
      operation:
        op: add
        path: /filter_chains/0/filters/0/typed_config/http_filters/0
        value:
          name: envoy.filters.http.geoip
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.geoip.v3.Geoip
            xff_config:
              xff_num_trusted_hops: 1
            provider:
              name: envoy.geoip_providers.maxmind
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.geoip_providers.maxmind.v3.MaxMindConfig
                common_provider_config:
                  geo_headers_to_add:
                    country: x-geo-country
                    asn: x-geo-asn
                city_db_path: /etc/envoy/maxmind/GeoLite2-City.mmdb
                asn_db_path: /etc/envoy/maxmind/GeoLite2-ASN.mmdb
    - type: type.googleapis.com/envoy.config.listener.v3.Listener
      name: envoy-gateway-system/external/external-https
      operation:
        op: add
        path: /filter_chains/0/filters/0/typed_config/http_filters/1
        value:
          name: envoy.filters.http.rbac
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBAC
            rules:
              action: ALLOW
              policies:
                only-ch:
                  permissions:
                    - header:
                        name: x-geo-country
                        string_match:
                          exact: CH
                  principals:
                    - any: true
                github-asn:
                  permissions:
                    - header:
                        name: x-geo-asn
                        string_match:
                          exact: "36459"
                  principals:
                    - any: true
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: block-admin-access
  namespace: envoy-gateway-system
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: external
  type: JSONPatch
  jsonPatches:
    - type: "type.googleapis.com/envoy.config.route.v3.RouteConfiguration"
      name: envoy-gateway-system/external/external-https
      operation:
        op: add
        jsonPath: "..virtual_hosts[?match(@.name, '.*(son|rad)arr_${BASE_DOMAIN/./_}')]"
        path: "typed_per_filter_config/envoy.filters.http.rbac"
        value:
          "@type": type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBACPerRoute
          rbac:
            rules:
              action: DENY
              policies:
                deny-admin-page:
                  permissions:
                    - header:
                        name: ":path"
                        safe_regex_match:
                          google_re2: {}
                          regex: "^/(settings|system).*"
                  principals:
                    - any: true
    - type: "type.googleapis.com/envoy.config.route.v3.RouteConfiguration"
      name: envoy-gateway-system/external/external-https
      operation:
        op: add
        jsonPath: "..virtual_hosts[?match(@.name, '.*sabnzbd_${BASE_DOMAIN/./_}')]"
        path: "typed_per_filter_config/envoy.filters.http.rbac"
        value:
          "@type": type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBACPerRoute
          rbac:
            rules:
              action: DENY
              policies:
                deny-admin-page:
                  permissions:
                    - header:
                        name: ":path"
                        safe_regex_match:
                          google_re2: {}
                          regex: "^/config.*"
                  principals:
                    - any: true
    - type: "type.googleapis.com/envoy.config.route.v3.RouteConfiguration"
      name: envoy-gateway-system/external/external-https
      operation:
        op: add
        jsonPath: "..virtual_hosts[?match(@.name, '.*cloud_${BASE_DOMAIN/./_}')]"
        path: "typed_per_filter_config/envoy.filters.http.rbac"
        value:
          "@type": type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBACPerRoute
          rbac:
            rules:
              action: DENY
              policies:
                deny-admin-page:
                  permissions:
                    - header:
                        name: ":path"
                        safe_regex_match:
                          google_re2: {}
                          regex: "^/settings/admin.*"
                  principals:
                    - any: true
    - type: "type.googleapis.com/envoy.config.route.v3.RouteConfiguration"
      name: envoy-gateway-system/external/external-https
      operation:
        op: add
        jsonPath: "..virtual_hosts[?match(@.name, '.*(sso|git)_${BASE_DOMAIN/./_}')]"
        path: "typed_per_filter_config/envoy.filters.http.rbac"
        value:
          "@type": type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBACPerRoute
          rbac:
            rules:
              action: DENY
              policies:
                deny-admin-page:
                  permissions:
                    - header:
                        name: ":path"
                        safe_regex_match:
                          google_re2: {}
                          regex: "^/admin.*"
                  principals:
                    - any: true
